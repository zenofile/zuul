table netdev blackhole {
{% if ip_versions.v4 %}
    set {{ set_names.whitelist }}_v4 {
        type ipv4_addr
        flags interval
        auto-merge
        {% if sets.whitelist_v4 %}
        elements = { {{ sets.whitelist_v4 }} }
        {% endif %}
    }

    set {{ set_names.blacklist}}_v4 {
        type ipv4_addr
        flags interval
        auto-merge
        {% if sets.blacklist_v4 %}
        elements = { {{ sets.blacklist_v4 }} }
        {% endif %}
    }

    set {{ set_names.abuselist }}_v4 {
        type ipv4_addr
        flags interval
        auto-merge
        {% if sets.abuselist_v4 %}
        elements = { {{ sets.abuselist_v4 }} }
        {% endif %}
    }

    set {{ set_names.country }}_v4 {
        type ipv4_addr
        flags interval
        auto-merge
        {% if sets.country_v4 %}
        elements = { {{ sets.country_v4 }} }
        {% endif %}
    }

    counter {{ set_names.whitelist }}_v4_cnt {}
    counter {{ set_names.blacklist}}_v4_cnt {}
    counter {{ set_names.abuselist }}_v4_cnt {}
    counter {{ set_names.country }}_v4_cnt {}
{% endif %}

{% if ip_versions.v6 %}
    set {{ set_names.whitelist }}_v6 {
        type ipv6_addr
        flags interval
        auto-merge
        {% if sets.whitelist_v6 %}
        elements = { {{ sets.whitelist_v6 }} }
        {% endif %}
    }

    set {{ set_names.blacklist}}_v6 {
        type ipv6_addr
        flags interval
        auto-merge
        {% if sets.blacklist_v6 %}
        elements = { {{ sets.blacklist_v6 }} }
        {% endif %}
    }

    set {{ set_names.abuselist }}_v6 {
        type ipv6_addr
        flags interval
        auto-merge
        {% if sets.abuselist_v6 %}
        elements = { {{ sets.abuselist_v6 }} }
        {% endif %}
    }

    set {{ set_names.country }}_v6 {
        type ipv6_addr
        flags interval
        auto-merge
        {% if sets.country_v6 %}
        elements = { {{ sets.country_v6 }} }
        {% endif %}
    }

    counter {{ set_names.whitelist }}_v6_cnt {}
    counter {{ set_names.blacklist}}_v6_cnt {}
    counter {{ set_names.abuselist }}_v6_cnt {}
    counter {{ set_names.country }}_v6_cnt {}
{% endif %}

    {% for iface in iifname %}
    chain input_{{ iface }} {
        type filter hook ingress device {{ iface }} priority -190; policy {{ default_policy }};

    {% if ip_versions.v4 %}
        ip saddr @{{ set_names.whitelist }}_v4 counter name {{ set_names.whitelist }}_v4_cnt accept
        ip saddr @{{ set_names.blacklist}}_v4 counter name {{ set_names.blacklist}}_v4_cnt goto log-debug
        ip saddr @{{ set_names.abuselist }}_v4 counter name {{ set_names.abuselist }}_v4_cnt goto log-debug
        ip saddr @{{ set_names.country }}_v4 counter name {{ set_names.country }}_v4_cnt goto log-debug
    {% endif %}

    {% if ip_versions.v6 %}
        ip6 saddr @{{ set_names.whitelist }}_v6 counter name {{ set_names.whitelist }}_v6_cnt accept
        ip6 saddr @{{ set_names.blacklist}}_v6 counter name {{ set_names.blacklist }}_v6_cnt goto log-debug
        ip6 saddr @{{ set_names.abuselist }}_v6 counter name {{ set_names.abuselist }}_v6_cnt goto log-debug
        ip6 saddr @{{ set_names.country }}_v6 counter name {{ set_names.country }}_v6_cnt goto log-debug
    {% endif %}
    }

    {% endfor %}

    chain log-debug {
    {% if logging.enabled %}
    {% if logging.ratelimiting %}
        limit rate {{ logging.rate }}/minute burst {{ logging.burst }} packets log level debug
    {% else %}
        log level debug
    {% endif %}
    {% endif %}
        {{ block_policy }}
    }
}
