{# =============================================================================
Variables available in this template context:

- iifname: list of interface names (strings)
- default_policy: nft chain policy for ingress chains (e.g. "accept")
- block_policy: action applied in log-target (e.g. "drop")
- logging.enabled, logging.level, logging.ratelimiting, logging.rate, logging.burst
- ip_versions.v4 / ip_versions.v6 (booleans)
- set_names.whitelist / blacklist / abuselist / country (base names)

- epoch: unix timestamp used to version dynamic sets (suffix "_{{ epoch }}")
- sets: map of "<basename>_<v4|v6>" -> set object
    - set.is_static: true for static sets, false for dynamic sets
    - set prints as a comma-separated list of nftables elements (usable in elements = { ... })
    - empty sets are omitted / treated as falsey

NOTE (keep stable / hardcoded):
    template block names "full_config", "sets_dynamic", "chain_validation",
    and nftables identifiers "table netdev blackhole" + chain name "validation"
============================================================================= #}

{# Block 1: Static Sets (Whitelist, Blacklist) #}
{% block sets_static %}
    {% for name, set in sets|items %}
        {% if set.is_static %}
            set {{ name }} {
                type {% if '_v4' in name %}ipv4_addr{% else %}ipv6_addr{% endif %};
                flags interval;
                auto-merge;
                {% if set %}
                    elements = { {{ set|safe }} }
                {% endif %}
    }
        {% endif %}
    {% endfor %}
{% endblock %}

{# Block 2: Dynamic Sets (Abuselist, Country) - with suffix #}
{% block sets_dynamic %}
    {% for name, set in sets|items %}
        {% if not set.is_static %}
            set {{ name }}_{{ epoch }} {
                type {% if '_v4' in name %}ipv4_addr{% else %}ipv6_addr{% endif %};
                flags interval;
                auto-merge;
                {% if set %}
                    elements = { {{ set|safe }} }
                {% endif %}
            }
        {% endif %}
    {% endfor %}
{% endblock %}

{# Block 3: Counters - created once, no suffix binding, persistent #}
{% block counters %}
    {% if ip_versions.v4 %}
        {% for base in [set_names.whitelist, set_names.blacklist, set_names.abuselist, set_names.country] %}
            counter {{ base }}_v4_cnt {}
        {% endfor %}
    {% endif %}
    {% if ip_versions.v6 %}
        {% for base in [set_names.whitelist, set_names.blacklist, set_names.abuselist, set_names.country] %}
            counter {{ base }}_v6_cnt {}
        {% endfor %}
    {% endif %}
{% endblock %}

{# Block 4: Chain Logic #}
{% block chain_logic %}
    {% for iface in iifname %}
    chain ingress_{{ iface }} {
        type filter hook ingress device "{{ iface }}" priority -190; policy {{ default_policy }};
        jump validation
    }
    {% endfor %}

    {# Define a sub-block we can target specifically during refresh #}
    {% block chain_validation %}
        chain validation {
            iifname "lo" accept

            {% if ip_versions.v4 %}
                {# Whitelist #}
                {% set wl_versioned = set_names.whitelist ~ "_v4" %}
                {% if sets[wl_versioned] is defined %}
                    ip saddr @{{ wl_versioned}} counter name {{ set_names.whitelist }}_v4_cnt accept
                {% endif %}

                {# Deny Sets, can be dynamic #}
                {% for base in [set_names.blacklist, set_names.abuselist, set_names.country] %}
                    {% set versioned = base ~ "_v4" %}
                    {% if sets[versioned] is defined %}
                        {% if not sets[versioned].is_static %}
                            {% set versioned = versioned ~ "_" ~ epoch %}
                        {% endif %}
                        ip saddr @{{ versioned}} counter name {{ base }}_v4_cnt goto log-target
                    {% endif %}
                {% endfor %}
            {% endif %}

            {% if ip_versions.v6 %}
                {# Whitelist #}
                {% set wl_versioned = set_names.whitelist ~ "_v6" %}
                {% if sets[wl_versioned] is defined %}
                    ip6 saddr @{{ wl_versioned}} counter name {{ set_names.whitelist }}_v6_cnt accept
                {% endif %}

                {# Deny Sets, can be dynamic #}
                {% for base in [set_names.blacklist, set_names.abuselist, set_names.country] %}
                    {% set versioned = base ~ "_v6" %}
                    {% if sets[versioned] is defined %}
                        {% if not sets[versioned].is_static %}
                            {% set versioned = versioned ~ "_" ~ epoch %}
                        {% endif %}
                        ip6 saddr @{{ versioned }} counter name {{ base }}_v6_cnt goto log-target
                    {% endif %}
                {% endfor %}
            {% endif %}
        }
    {% endblock %}

    chain log-target {
    {% if logging.enabled %}
    {% if logging.ratelimiting %}
        limit rate {{ logging.rate }}/minute burst {{ logging.burst }} packets log level {{
            logging.level }}
    {% else %}
        log level {{ logging.level }}
    {% endif %}
    {% endif %}
        {{ block_policy }}
    }
{% endblock %}

{# Main: Full Configuration, combine all blocks #}
{% block full_config %}
    table netdev blackhole {
        {{ self.sets_static() }}
        {{ self.sets_dynamic() }}
        {{ self.counters() }}
        {{ self.chain_logic() }}
    }
{% endblock %}
